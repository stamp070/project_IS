import streamlit as st
import tensorflow as tf
import numpy as np
from PIL import Image
import matplotlib.pyplot as plt

# р╣Вр╕лр╕ер╕Фр╣Вр╕бр╣Ар╕Фр╕ер╕Чр╕╡р╣Ир╕Эр╕╢р╕Бр╣Др╕зр╣Й
model = tf.keras.models.load_model("./models/cifar10_cnn_model.h5")

# р╕лр╕бр╕зр╕Фр╕лр╕бр╕╣р╣Ир╕Вр╕нр╕З CIFAR-10
class_names = ["Airplane", "Automobile", "Bird", "Cat", "Deer", 
               "Dog", "Frog", "Horse", "Ship", "Truck"]

# р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╕лр╕Щр╣Йр╕▓р╣Ар╕зр╣Зр╕Ъ
st.set_page_config(page_title="CIFAR-10 Image Classification", layout="wide")

# р╕кр╣Ир╕зр╕Щр╕лр╕▒р╕зр╕Вр╕нр╕Зр╕лр╕Щр╣Йр╕▓
st.title("ЁЯЪА р╕гр╕░р╕Ър╕Ър╕Ир╕│р╣Бр╕Щр╕Бр╕ар╕▓р╕Ю CIFAR-10 р╕Фр╣Йр╕зр╕в CNN")
st.write("ЁЯУМ р╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Фр╕гр╕╣р╕Ыр╕ар╕▓р╕Юр╣Бр╕ер╕░р╣Гр╕лр╣Йр╣Вр╕бр╣Ар╕Фр╕ер╕Кр╣Ир╕зр╕вр╕Чр╕│р╕Щр╕▓р╕в!")

# р╣Бр╕кр╕Фр╕Зр╕гр╕▓р╕вр╕Бр╕▓р╕гр╕Вр╕нр╕Зр╕Др╕ер╕▓р╕к CIFAR-10
st.subheader("ЁЯУЛ р╕гр╕▓р╕вр╕Бр╕▓р╕гр╕лр╕бр╕зр╕Фр╕лр╕бр╕╣р╣Ир╕Чр╕╡р╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╕Ир╕│р╣Бр╕Щр╕Бр╣Др╕Фр╣Йр╣Гр╕Щ CIFAR-10")
st.markdown("""
тЬЕ **р╕лр╕бр╕зр╕Фр╕лр╕бр╕╣р╣Ир╕Вр╕нр╕Зр╕ар╕▓р╕Юр╕Чр╕╡р╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╕Ир╕│р╣Бр╕Щр╕Бр╣Др╕Фр╣Й**:
- тЬИя╕П **Airplane** (р╣Ар╕Др╕гр╕╖р╣Ир╕нр╕Зр╕Ър╕┤р╕Щ)
- ЁЯЪЧ **Automobile** (р╕гр╕Цр╕вр╕Щр╕Хр╣М)
- ЁЯРж **Bird** (р╕Щр╕Б)
- ЁЯР▒ **Cat** (р╣Бр╕бр╕з)
- ЁЯжМ **Deer** (р╕Бр╕зр╕▓р╕З)
- ЁЯР╢ **Dog** (р╕кр╕╕р╕Щр╕▒р╕В)
- ЁЯР╕ **Frog** (р╕Бр╕Ъ)
- ЁЯР┤ **Horse** (р╕бр╣Йр╕▓)
- ЁЯЪв **Ship** (р╣Ар╕гр╕╖р╕н)
- ЁЯЪЪ **Truck** (р╕гр╕Цр╕Ър╕гр╕гр╕Чр╕╕р╕Б)
""")

# р╣Бр╕кр╕Фр╕Зр╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕Зр╕Вр╕нр╕Зр╕лр╕бр╕зр╕Фр╕лр╕бр╕╣р╣Ир╣Гр╕Щ CIFAR-10
st.subheader("ЁЯФН р╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕Зр╕лр╕бр╕зр╕Фр╕лр╕бр╕╣р╣Ир╕Вр╕нр╕З CIFAR-10 р╕Чр╕╡р╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╕Ир╕│р╣Бр╕Щр╕Бр╣Др╕Фр╣Й")
sample_images = {
    "ЁЯЪЪ Truck": "./image/NN/truck.jpg",
    "ЁЯжМ Deer": "./image/NN/deer.jpg",
    "ЁЯР▒ Cat": "./image/NN/cat.jpg",
    "ЁЯР╕ Frog": "./image/NN/frog.jpg",
}

col1, col2, col3, col4 = st.columns(4)
for col, (label, img_path) in zip([col1, col2, col3, col4], sample_images.items()):
    col.image(img_path, caption=label)

st.markdown("---")  # р╣Ар╕кр╣Йр╕Щр╕Др╕▒р╣Ир╕Щ

# р╕Др╕│р╣Бр╕Щр╕░р╕Щр╕│р╣Ар╕Бр╕╡р╣Ир╕вр╕зр╕Бр╕▒р╕Ър╕Бр╕▓р╕гр╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Фр╕гр╕╣р╕Ыр╕ар╕▓р╕Ю
st.subheader("ЁЯУд р╕зр╕┤р╕Шр╕╡р╕Бр╕▓р╕гр╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Фр╕гр╕╣р╕Ыр╕ар╕▓р╕Ю")
st.write("""
тЬЕ **р╣Ар╕ер╕╖р╕нр╕Бр╕гр╕╣р╕Ыр╕ар╕▓р╕Юр╕Чр╕╡р╣Ир╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕г** р╣Вр╕Фр╕вр╕кр╕▓р╕бр╕▓р╕гр╕Цр╣Ар╕Ыр╣Зр╕Щр╕гр╕╣р╕Ыр╕Чр╕╡р╣Ир╕бр╕╡р╕нр╕вр╕╣р╣Ир╣Бр╕ер╣Йр╕зр╣Гр╕Щр╕нр╕╕р╕Ыр╕Бр╕гр╕Ур╣Мр╕Вр╕нр╕Зр╕Др╕╕р╕У  
тЬЕ **р╕Ыр╕гр╕░р╣Ар╕ар╕Чр╕Вр╕нр╕Зр╕гр╕╣р╕Ыр╕ар╕▓р╕Ю**: р╣Др╕Яр╕ер╣Мр╕Хр╣Йр╕нр╕Зр╣Ар╕Ыр╣Зр╕Щ **JPG, JPEG р╕лр╕гр╕╖р╕н PNG**  
тЬЕ **р╕ар╕▓р╕Юр╕Др╕зр╕гр╕бр╕╡р╕Др╕зр╕▓р╕бр╕Кр╕▒р╕Фр╣Ар╕Ир╕Щ** р╣Бр╕ер╕░р╕Др╕зр╕гр╣Ар╕Ыр╣Зр╕Щр╕ар╕▓р╕Юр╕Чр╕╡р╣Ир╕Хр╕гр╕Зр╕Бр╕▒р╕Ър╕лр╕бр╕зр╕Фр╕лр╕бр╕╣р╣Ир╕Вр╕нр╕З CIFAR-10  
""")

# р╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Фр╕ар╕▓р╕Ю
uploaded_file = st.file_uploader("ЁЯУд р╕Бр╕гр╕╕р╕Ур╕▓р╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Фр╕ар╕▓р╕Юр╕Вр╕нр╕Зр╕Др╕╕р╕Ур╕Чр╕╡р╣Ир╕Щр╕╡р╣И...", type=["jpg", "png", "jpeg"])

if uploaded_file is not None:
    # р╣Бр╕кр╕Фр╕Зр╕ар╕▓р╕Юр╕Чр╕╡р╣Ир╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Ф
    image = Image.open(uploaded_file)
    st.image(image, caption="ЁЯУ╕ р╕ар╕▓р╕Юр╕Чр╕╡р╣Ир╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Ф", width=200)

    # р╣Бр╕Ыр╕ер╕Зр╕ар╕▓р╕Юр╣Гр╕лр╣Йр╕Хр╕гр╕Зр╕Бр╕▒р╕Ър╕гр╕╣р╕Ыр╣Бр╕Ър╕Ър╕Чр╕╡р╣Ир╣Вр╕бр╣Ар╕Фр╕ер╣Гр╕Кр╣Й
    img_array = np.array(image.resize((32, 32))) / 255.0  # р╕Ыр╕гр╕▒р╕Ър╕Вр╕Щр╕▓р╕Фр╣Бр╕ер╕░ Normalize
    img_array = np.expand_dims(img_array, axis=0)  # р╣Ар╕Юр╕┤р╣Ир╕бр╕бр╕┤р╕Хр╕┤р╣Гр╕лр╣Йр╣Ар╕лр╕бр╕▓р╕░р╕Бр╕▒р╕Ър╣Вр╕бр╣Ар╕Фр╕е

    # р╕Чр╕│р╕Бр╕▓р╕гр╕Чр╕│р╕Щр╕▓р╕в
    prediction = model.predict(img_array)
    predicted_class = class_names[np.argmax(prediction)]
    confidence_scores = prediction[0] * 100  # р╕Др╕│р╕Щр╕зр╕Ур╣Ар╕Ыр╕нр╕гр╣Мр╣Ар╕Лр╣Зр╕Щр╕Хр╣Мр╕Др╕зр╕▓р╕бр╕бр╕▒р╣Ир╕Щр╣Гр╕И

    # р╣Бр╕кр╕Фр╕Зр╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣М
    st.subheader(f"ЁЯФН **р╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣М: {predicted_class}**")

    # р╣Бр╕кр╕Фр╕Зр╕Бр╕гр╕▓р╕Яр╣Бр╕Чр╣Ир╕Зр╕Др╕зр╕▓р╕бр╕Щр╣Ир╕▓р╕Ир╕░р╣Ар╕Ыр╣Зр╕Щр╕Вр╕нр╕Зр╣Бр╕Хр╣Ир╕ер╕░р╕Др╕ер╕▓р╕к
    fig, ax = plt.subplots(figsize=(6, 4))
    ax.barh(class_names, confidence_scores, color="skyblue")
    ax.set_xlim(0, 100)  # р╕Бр╕│р╕лр╕Щр╕Фр╕Вр╕нр╕Ър╣Ар╕Вр╕Хр╕Вр╕нр╕Зр╣Бр╕Бр╕Щ X
    ax.set_xlabel("Confidence (%)")
    ax.set_title("Class Probability Distribution")
    st.pyplot(fig)

st.markdown("---")  # р╣Ар╕кр╣Йр╕Щр╕Др╕▒р╣Ир╕Щ
st.write("ЁЯОп **р╕лр╕бр╕▓р╕вр╣Ар╕лр╕Хр╕╕**: р╣Вр╕бр╣Ар╕Фр╕ер╕Цр╕╣р╕Бр╕Эр╕╢р╕Бр╕Фр╣Йр╕зр╕вр╕Кр╕╕р╕Фр╕Вр╣Йр╕нр╕бр╕╣р╕е CIFAR-10 р╣Бр╕ер╕░р╕нр╕▓р╕Ир╕бр╕╡р╕Вр╣Йр╕нр╕Ир╕│р╕Бр╕▒р╕Фр╣Гр╕Щр╕Бр╕▓р╕гр╕Чр╕│р╕Щр╕▓р╕вр╕ар╕▓р╕Юр╕Чр╕╡р╣Ир╣Бр╕Хр╕Бр╕Хр╣Ир╕▓р╕Зр╕Ир╕▓р╕Бр╕ар╕▓р╕Юр╕Эр╕╢р╕Б")
